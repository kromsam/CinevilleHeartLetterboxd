<!DOCTYPE html>
<html lang="nl"> <!-- Language set to Dutch -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <script>
        // Function to fetch the contents of a text file
        function fetchTextFile(filePath) {
            return fetch(filePath)
                .then(response => response.text())
                .catch(error => {
                    console.error('Error fetching file:', error);
                    return null;
                });
        }
    
        // Fetch the contents of the letterboxd_list.txt and locations.txt files
        Promise.all([
            fetchTextFile('../input/letterboxd_list.txt'),
            fetchTextFile('../input/locations.txt')
        ])
        .then(([letterboxdListContent, locationsContent]) => {
            if (letterboxdListContent && locationsContent) {
                // Create a URL for the letterboxd_list part
                const letterboxdList = letterboxdListContent.trim();
                const letterboxdListURL = `https://letterboxd.com/${letterboxdList}`;
                
                // Create the heading text with the letterboxd_list part as a URL
                const headingText = `Films in ${locationsContent.trim()} van <a href="${letterboxdListURL}" target="_blank">${letterboxdList}</a>`;
                
                // Update the <h1> element
                const h1Element = document.querySelector('h1');
                h1Element.innerHTML = headingText;
                
                // Update the page title
                document.title = `Films in ${locationsContent.trim()} van ${letterboxdList}`;
            }
        })
        .catch(error => console.error('Error fetching text files:', error));
    </script>    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans:400,700" rel="stylesheet">
    <style>
        body {
            font-family: 'Fira Sans', sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .card {
            border: 1px solid #ccc;
            margin: 10px;
            background-color: #fff;
        }

        .card img {
            max-height: 300px;
            object-fit: cover;
        }

        .card-title {
            font-size: 1.5rem;
            padding: 10px;
        }

        .card-text {
            font-size: 1.1rem;
            padding: 10px;
        }

        .list-group-item {
            font-size: 1rem;
            display: block;
        }

        .showing-details {
            margin-top: 10px;
        }

        .showing {
            border: 1px solid #eee;
            padding: 10px;
            margin: 5px 0;
        }

        .showing-item {
            margin: 5px 0;
        }

        .screening-info {
            padding: 10px;
            font-style: italic;
            background-color: #f9f9f9;
        }

        .additional-info {
            font-style: italic;
        }

        /* Style for film links */
        .film-links {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mt-4 mb-4"></h1>
        <div class="row" id="filmCards"></div>
    </div>

    <script>
        function groupShowingsByDateAndTheater(showings) {
            const groupedShowings = {};
            showings.forEach(showing => {
                const date = showing.date;
                const theater = showing.location_name;
                if (!groupedShowings[date]) {
                    groupedShowings[date] = {};
                }
                if (!groupedShowings[date][theater]) {
                    groupedShowings[date][theater] = [];
                }
                groupedShowings[date][theater].push(showing);
            });
            return groupedShowings;
        }
    
        function formatDateToDutch(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString('nl-NL', options);
        }
    
        function toggleCardCollapse(cardId) {
            const card = document.getElementById(cardId);
            const cardCollapse = card.querySelector('.card-collapse');
            cardCollapse.classList.toggle('show');
        }
    
        function getFirstScreeningDate(film) {
            const screeningDates = film.showings
                .filter(showing => showing.date)
                .map(showing => new Date(showing.date));
    
            if (screeningDates.length > 0) {
                screeningDates.sort((a, b) => a - b);
                return screeningDates[0];
            }
    
            return null;
        }
    
        function getEarliestScreeningTime(film) {
            const times = film.showings
                .filter(showing => showing.date)
                .map(showing => showing.time_start);
    
            if (times.length > 0) {
                times.sort();
                return times[0];
            }
    
            return null;
        }
    
        function addLinks(film) {
            let links = '';
    
            if (film.url) {
                links += `<a href="${film.url}" target="_blank">Cineville</a>`;
            }
    
            if (film.lb_url) {
                links += `<a href="${film.lb_url}" target="_blank">Letterboxd</a>`;
            }
    
            if (film.imdb_id) {
                links += `<a href="https://www.imdb.com/title/${film.imdb_id}" target="_blank">IMDb</a>`;
            }
    
            if (film.tmdb_id) {
                links += `<a href="https://www.themoviedb.org/movie/${film.tmdb_id}" target="_blank">TMDB</a>`;
            }
    
            return links;
        }
    
        fetch('films_with_showings.json')
            .then(response => response.json())
            .then(data => {
                const filmCards = document.getElementById('filmCards');
    
                data.sort((a, b) => {
                    const firstScreeningA = getFirstScreeningDate(a);
                    const firstScreeningB = getFirstScreeningDate(b);
    
                    if (firstScreeningA && firstScreeningB) {
                        if (firstScreeningA - firstScreeningB === 0) {
                            const earliestTimeA = getEarliestScreeningTime(a);
                            const earliestTimeB = getEarliestScreeningTime(b);
    
                            if (earliestTimeA && earliestTimeB) {
                                return earliestTimeA.localeCompare(earliestTimeB);
                            }
                        }
                        return firstScreeningA - firstScreeningB;
                    } else if (firstScreeningA) {
                        return -1;
                    } else if (firstScreeningB) {
                        return 1;
                    }
                    return 0;
                });
    
                data.forEach((film, index) => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4';
    
                    const showingCount = film.showings.length;
    
                    const showingsOrInfo = film.showings[0].date
                        ? `
                            <button class="btn btn-link" data-toggle="collapse" data-target="#collapse-${index}">
                                Toon ${showingCount} ${showingCount === 1 ? 'Voorstelling' : 'Voorstellingen'}
                            </button>
                            <div class="collapse card-collapse" id="collapse-${index}">
                                <ul class="list-group list-group-flush">
                                    ${Object.entries(groupShowingsByDateAndTheater(film.showings)).map(([date, theaters]) => `
                                        <li class="list-group-item">
                                            <strong>${formatDateToDutch(date)}</strong>
                                            <div class="showing-details">
                                                ${Object.entries(theaters).map(([theater, showings]) => `
                                                    <div class="showing">
                                                        <strong>${theater}</strong>
                                                        ${showings.map(showing => `
                                                            <div class="showing-item">
                                                                ${showing.additional_info ? `<span class="additional-info">${showing.additional_info}</span>` : ''}
                                                                <p>${showing.time_start} - ${showing.time_end}</p>
                                                                <a href="${showing.ticket_url}" class="btn btn-primary btn-sm" target="_blank">Koop Tickets</a>
                                                                <a href="${showing.information_url}" class="btn btn-secondary btn-sm" target="_blank">Meer Informatie</a>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `
                        : `
                            <div class="card-collapse screening-info">
                                <p>${film.showings[0].screening_info}</p>
                            </div>
                        `;
    
                    const links = addLinks(film);
    
                    card.innerHTML = `
                        <div class="card">
                            <a href="${film.url}" target="_blank">
                                <img src="${film.img_url}" class="card-img-top">
                            </a>
                            <div class="card-body">
                                <h2 class="card-title">${film.title}</h2>
                                <div class="film-links">
                                <a href="${film.url}" class="btn btn-primary btn-sm" target="_blank">Cineville</a>
                                <a href="${film.lb_url}" class="btn btn-primary btn-sm" target="_blank">Letterboxd</a>
                                ${film.imdb_id ? `<a href="https://www.imdb.com/title/${film.imdb_id}" class="btn btn-primary btn-sm" target="_blank">IMDb</a>` : ''}
                                <a href="https://www.themoviedb.org/movie/${film.tmdb_id}" class="btn btn-primary btn-sm" target="_blank">TMDB</a>
                            </div>
                                <p class="card-text">${film.oneliner}</p>
                            </div>
                            ${showingsOrInfo}
                        </div>
                    `;
                    filmCards.appendChild(card);
                });
            })
            .catch(error => console.error('Fout bij het ophalen van gegevens: ', error));
    </script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>

</html>
